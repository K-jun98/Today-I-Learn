
## 📚 TIL

---

### `Daily`
- [ ] 

---
### `Today`
- [X] 자바 ORM 표준 JPA 프로그래밍 15 ~ 16장
- [X] Practical Testing: 실용적인 테스트 가이드 섹션 6, 7

---
### `학습 키워드`

- JPA 표준 예외는 크게 2가지
  - 트랜잭션 롤백을 표시하는 예외
  - 트랜잭션 롤백을 표시하지 않는 예외

`트랜잭션 롤백을 표시하는 예외는 심각한 예외이므로 복구해선 안 된다. 이 예외가 발생하면 트랜잭션을 강제로 커밋해도 트랜잭션이 커밋되지 않고 대신에 RollbackException 예외가 발생한다.`

---

- 스프링 프레임워크의 JPA 예외 변환
  - 서비스 계층에서 데이터 접근 계층의 구현 기술에 직접 의존하는 것은 좋은 설계라 할 수 없다. 예외도 마찬가지인데, 이 문제를 해결하려고 데이터 접근 계층에 대한 예외를 추상화해서 개발자에게 제공하낟.
  - `@Repository` 어노테이션을 사용한 곳에 예외 변환 `AOP`를 적용해서 JPA 예외를 스프링 프레임워크가 추상화한 예외로 변환해준다.

---

- 트랜잭션 롤백 시 주의사항
  - `트랜잭션을 롤백하는 것은 데이터베이스의 반영사항만 롤백하는 것이지 수정한 자바 객체까지 원상태로 복구해주지는 않는다.`

---

- 엔티티 비교
  - 영속성 컨텍스트 내부에는 엔티티 인스턴스를 보관하기 위한 1차 캐시가 있다. `이 1차 캐시는 영속성 컨텍스트와 생명주기를 같이 한다.`

---
    
- 읽기 전용 쿼리의 성능 최적화
  - 영속성 컨텍스트는 변경 감지를 위해 `스냅샷 인스턴스를 보관하므로 더 많은 메모리를 사용`한다. 단순 조회로 수정할 일이 없다면 읽기 전용으로 조회하면 메모리 사용량을 최적화할 수 있다.
    - 스칼라 타입으로 조회
      - `select o.id, o.name, o.price from p`
    - 읽기 전용 쿼리 힌트 사용
      - `query.setHint(readOnly = true)`
      - 하이버네이트 전용 힌트인 readOnly를 사용하면 엔티티를 읽기 전용으로 조회할 수 있다.
    - 읽기 전용 트랜잭션 사용
      - `@Transactional(readOnly = true)`
      - 하이버네이트 세션의 플러시 모드를 MANUAL로 설정한다. 이렇게 하면 강제로 플러시를 호출하지 않는 한 플러시가 일어나지 않는다. 즉 트랜잭션을 커밋해도 플러시가 일어나지 않음
    - 트랜잭션 밖에서 읽기
      - 트랜잭션 밖에서 읽는다는 것은 트랜잭션 없이 엔티티를 조회한다는 뜻. 물론 JPA에서 데이터를 변경하려면 트랜잭션은 필수므로 조회가 목적일 때만 사용해야 한다.
      - `@TransactionAttribute(porpagation = Propagation.NOT_SUPPOTED)`
```
읽기 전용 데이터를 조회할 때, 메모리를 최적화 하려면 스칼라 타입으로 조회하거나 하이버네이트가 제공하는 읽기 전용 쿼리 힌트를 사용하면 되고,
플러시 호출을 막아서 속도를 최적화하려면 읽기 전용 트랜잭션을 사용하거나 트랜잭션 밖에서 읽기를 사용하면 된다.
```

---
Mock - 행위 검증
Stub - 상태 검증
